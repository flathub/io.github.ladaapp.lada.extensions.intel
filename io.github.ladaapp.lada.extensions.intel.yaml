id: io.github.ladaapp.lada.extensions.intel
runtime: io.github.ladaapp.lada
runtime-version: 'beta'
sdk: org.gnome.Sdk//49
build-extension: true
separate-locales: false
modules:
  # source: https://gitlab.archlinux.org/archlinux/packaging/packages/intel-graphics-compiler/-/blob/main/PKGBUILD
  - name: intel-graphics-compiler
    buildsystem: simple
    build-commands:
      - ls -lh $FLATPAK_BUILDER_BUILDDIR/intel-graphics-compiler-2.27.10/external/llvm/releases/16.0.0/patches_external/
      - |
        # rename to prevent SPIRV-LLVM-Translator from being included
        # twice by the build process, which causes the build to fail
        mv SPIRV-LLVM-Translator{,-IGC-LLVM}

        ln -s "SPIRV-LLVM-Translator-IGC-LLVM"  "llvm-project/llvm/projects/llvm-spirv"
        ln -s "opencl-clang" "llvm-project/llvm/projects/opencl-clang"
      - patch -Np1 -d "intel-graphics-compiler-2.27.10" < 010-intel-graphics-compiler-disable-werror.patch
      - patch -Np1 -d "llvm-project" < llvm.patch
      - ls -lh $FLATPAK_BUILDER_BUILDDIR/intel-graphics-compiler-2.27.10/external/llvm/releases/16.0.0/patches_external/
      - ls -lh "/run/build/intel-graphics-compiler/llvm-project/llvm"
      - chmod -R 777 llvm-project/llvm
      - |
        # Prevent IGC to load LLVM 17+ symbols
        export CFLAGS+=' -fno-semantic-interposition'
        export CXXFLAGS+=' -fno-semantic-interposition'
        export LDFLAGS+=' -Wl,-Bsymbolic'
        
        # fix error: "_FORTIFY_SOURCE" redefined [-Werror]
        # note: upstream forces _FORTIFY_SOURCE=2
        export CFLAGS="${CFLAGS/-Wp,-D_FORTIFY_SOURCE=?/}"
        export CXXFLAGS="${CXXFLAGS/-Wp,-D_FORTIFY_SOURCE=?/}"
    
        export GIT_COMMITTER_NAME='builduser'
        export GIT_COMMITTER_EMAIL='builduser@archlinux.org'
        
        cmake -B build -S "intel-graphics-compiler-2.27.10" \
            -G 'Unix Makefiles' \
            -DCCLANG_FROM_SYSTEM=OFF \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_LIBDIR=lib \
            -DCMAKE_INSTALL_PREFIX=/app \
            -DCMAKE_POLICY_VERSION_MINIMUM=3.5.0 \
            -DCMAKE_SKIP_RPATH=YES \
            -DIGC_OPTION__CLANG_MODE=Source \
            -DIGC_OPTION__LINK_KHRONOS_SPIRV_TRANSLATOR=ON \
            -DIGC_OPTION__LLD_MODE=Source \
            -DIGC_OPTION__LLVM_MODE=Source \
            -DIGC_OPTION__LLVM_PREFERRED_VERSION="16.0.6" \
            -DIGC_OPTION__SPIRV_TOOLS_MODE=Source \
            -DIGC_OPTION__USE_PREINSTALLED_SPIRV_HEADERS=OFF \
            -DIGC_OPTION__VC_INTRINSICS_MODE=Source \
            -Wno-dev
        cmake --build build
      - |
        pkgdir=/app
        pkgname=intel-graphics-compiler
        pkgver=2.27.10
        DESTDIR="$pkgdir" cmake --install build
        install -D -m644 "${pkgname}-${pkgver}"/LICENSE.md -t "${pkgdir}/usr/share/licenses/${pkgname}"
        mv "${pkgdir}/usr/include"/opencl-c{,-base}.h "${pkgdir}/usr/include/igc"
        mv "${pkgdir}/usr/lib/igc${pkgver%%.*}/NOTICES.txt" "${pkgdir}/usr/share/licenses/${pkgname}"
        
        # additional files for opencl-clang
        install -D -m644 opencl-clang/opencl_clang.h -t "${pkgdir}/usr/include/cclang"
        install -D -m644 opencl-clang/LICENSE "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE-opencl-clang"
        ln -s "libopencl-clang.so.16" "${pkgdir}/usr/lib/libopencl-clang.so"
    sources:
#      - type: archive
#        url: https://github.com/intel/intel-graphics-compiler/archive/v2.27.10/intel-graphics-compiler-2.27.10.tar.gz
#        sha256: 3e6114f0c371ed88e1b0930b35ff8ac468c63f5448bf52e31341223e19cf572f
#        dest: intel-graphics-compiler-2.27.10
      - type: git
        url: https://github.com/intel/intel-graphics-compiler
        tag: v2.27.10
        dest: intel-graphics-compiler-2.27.10
      - type: git
        url: https://github.com/intel/vc-intrinsics.git
        tag: v0.24.2
        dest: vc-intrinsics
      - type: git
        url: https://github.com/KhronosGroup/SPIRV-LLVM-Translator.git
        commit: ee2a14e38f24c422cf1f0375b5b9cec0afe4412c
        dest: SPIRV-LLVM-Translator
      - type: git
        url: https://github.com/KhronosGroup/SPIRV-Tools.git
        commit: 28a883ba4c67f58a9540fb0651c647bb02883622
        dest: SPIRV-Tools
      - type: git
        url: https://github.com/KhronosGroup/SPIRV-Headers.git
        commit: 01e0577914a75a2569c846778c2f93aa8e6feddd
        dest: SPIRV-Headers
      - type: git
        url: https://github.com/intel/opencl-clang.git
        commit: 6ab2da341420eba7d022a85a5190c46133347719
        dest: opencl-clang
      - type: git
        url: https://github.com/llvm/llvm-project.git
        tag: llvmorg-16.0.6
        commit: 7cbf1a2591520c2491aa35339f227775f4d3adf6
        dest: llvm-project
      - type: file
        url: https://gitlab.archlinux.org/archlinux/packaging/packages/intel-graphics-compiler/-/raw/b101628d15c65a811526697a37e6557ef3eb496d/010-intel-graphics-compiler-disable-werror.patch
        sha256: eac4352a78d537e8a6bbca55c059377dc704e3e1e5a267c99a0e9edda7a87380
        dest-filename: 010-intel-graphics-compiler-disable-werror.patch
      - type: file
        url: https://github.com/llvm/llvm-project/commit/7e44305041d96b064c197216b931ae3917a34ac1.diff
        sha256: e7c640dac3b63ce7bf47493c73fc87231143a01ad385e0fb0fb47984b5e98551
        dest-filename: llvm.patch
  - python-dependencies.yaml
  - name: metainfo
    buildsystem: simple
    build-commands:
      - install -Dm644 ${FLATPAK_ID}.metainfo.xml -t ${FLATPAK_DEST}/share/metainfo
    sources:
      - type: file
        # todo: switch to tag once we have a new release
        url: https://codeberg.org/ladaapp/lada/raw/commit/c340f7d8dfde4fd60b857927633b296c5271238e/packaging/flatpak/extension_intel/io.github.ladaapp.lada.extensions.intel.metainfo.xml
        sha256: 541ee4e6978d6f5e3385f0a2289017237027164aa6ef9ff690351b65f17fb9a8
